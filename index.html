<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <title>Examinating</title>
    <script src="https://raw.githubusercontent.com/mholt/PapaParse/master/papaparse.js"></script>
</head>
<body>
    <div>
        <ul class="site-page-links" onload="displayModulesBox()">
            <li><a  href="index.html" id="MyModules">My Modules</a></li>
            <li><a  href="courses.html" id="All Courses">All Courses</a></li>
            <li><a  href="about.html" id="About">About</a></li>
        </ul>
    </div>
    <div>
      <input type="checkbox" id="Maths" onclick='setUserDetails(MA2111);'> I like Maths<br>
      <input type="checkbox" id="Science" onclick='setUserDetails(ST2641);'> I like Science<br>
    </div>
    <div id="modulesBox" onload="displayModulesBox()">
    </div>
    <div id="yearsBox" onload="displayYears()">
    </div>
    <script>
        
        var NEW_USER = 0;
        var LAST_ACTIVE_MODULE = 1;
        var MODULES = 2;
        var YEARS = 2016-1998;
        
        window.addEventListener('load',function(){ startUp();},false);
        //document.getElementById("Maths").addEventListener("onchange",function(){console.log("1");setUserDetails("MA2111");console.log("2");});
        //document.getElementById("Science").addEventListener("onchange",function(){console.log("3");setUserDetails("ST2641");console.log("4");});
        
        //Deal with how e.g. Elementary Greek is CL0021 and CL1005 (fix them in the CSV maybe?)
              
        //Code run once the page is loaded.
        var startUp = function(){
            parseData("https://raw.githubusercontent.com/nating/examinating/master/PastPapers.csv", updateData);
        }
        parseData = function(url, callBack) {
            Papa.parse(url,{download: true, dynamicTyping: true, complete: function(results){ callBack(results.data);} });
        }
        updateData = function(parsedFile) {
            data = parsedFile;
            var modules = document.getElementById("MyModules");
            modules.innerHTML = data.length;
            displayModulesBox(data);
            var userDetails = getUserDetails();
            console.log();
            if(userDetails==""){
                displayYears(data,"");
            }
            else{
                var lastActiveModule = userDetails[LAST_ACTIVE_MODULE];
                displayYears(data,lastActiveModule);
            }
        }
        //Display the appropriate content for the user in the modulesBox.
        var displayModulesBox = function(data){
            var userDetails = getUserDetails();
            if(userDetails==""){
                var modulesBox = document.getElementById("modulesBox");
                modulesBox.innerHTML =`<p>
                        Welcome to Trinity Exam Papers. This website is for students to find past papers in a less convoluted way.

                        This site uses cookies to remember what modules you do so that it can show you their past papers here when you visit it.

                        To have your modules' past papers show up on the home page, tick which modules you study on the "All Courses" page.
                    </p>`;
            }
            else{
                var htmlListOfModuleNames = "<ul>"
                for(var i=MODULES;i<userDetails.length;i++){
                    var index = getLinkIndex(data,userDetails[i]);
                    htmlListOfModuleNames += "<li id=\""+data[index][0]+"\">"+data[index][0]+" "+data[index][2]+"</li>";
                }
                var htmlListOfModuleNames = "</ul>"
            
                var modulesBox = document.getElementById("modulesBox");
                modulesBox.innerHTML = htmlListOfModuleNames;
            }
        };
        
        //Display the years for a module in the yearsBox.
        var displayYears = function(data,moduleCode){
            if(moduleCode==""){ return -1; }
            var htmlListOfYears = "<ul>"
            for(var year=2016;year>1997;year--){
                if(isLink(data,moduleCode,year)){
                    link = getLink(data,moduleCode,year);
                    htmlListOfYears += "<li><a href=\""+link+"\">"+year+"</a></li>";
                }
            }
            var htmlListOfModuleNames = "</ul>"
            var yearsBox = document.getElementById("yearsBox");
            yearsBox.innerHTML = htmlListOfYears;
        
            for(var year=2016;year>1997;year--){
                if(isLink(data,moduleCode,year)){
                    link = getLink(data,moduleCode,year);
                    htmlListOfYears += "<li><a href=\""+link+"\">"+year+"</a></li>";
                }
            }
        };
        
        //Binary search data for module code.
        var getLinkIndex = function(data,moduleCode){
            
            var low = 0;
            var high = data.length-1;
            var centre;
            var moduleCodeAtCentre;
            
            while(low<=high){
                centre = Math.round((low+high)/2);
                moduleCodeAtCentre = data[centre][0];
                if(moduleCodeAtCentre==moduleCode){
                    return centre;
                }
                else if(moduleCodeAtCentre < moduleCode){
                    low = centre+1;
                }
                if(moduleCodeAtCentre > moduleCode){
                    high = centre-1;
                }
            }
            console.log("No link was found for the moduleCode: "+moduleCode);
            return -1;
        };
        
        
        //Check if the module has a link for that year.
        var isLink = function(data,module,year){
            var index = getLinkIndex(data,module);
            if(index!=-1){
                for(var i=0;i<YEARS;i++){
                    if(data[index+i][1]==year){
                        return true;
                    }
                }
            }
            return false;
        };
        
        
        //Get the link for a specific year of a module.
        var getLink = function(data,module,year){
            var index = getLinkIndex(data,module);
            for(var i=0;i<YEARS;i++){
                if(data[index+i][1]==year){
                    return data[index][3];
                }
            }
            return "No link found."
        };
        
        /*
        getCookie = function(c_name) {
            if (document.cookie.length > 0) {
                c_start = document.cookie.indexOf(c_name + "=");
                if (c_start != -1) {
                    c_start = c_start + c_name.length + 1;
                    c_end = document.cookie.indexOf(";", c_start);
                    if (c_end == -1) {
                        c_end = document.cookie.length;
                    }
                    return unescape(document.cookie.substring(c_start, c_end));
                }
            }
            return "";
        }
        */
        
        //Get the user details from the Cookie. Returns an array of values or an empty String.
        var getUserDetails = function(){
            if (document.cookie.length > 0) {
                console.log("The cookie is: "+document.cookie);
                return document.cookie.split(',');
            }
            console.log("There is no cookie at the moment.");
            return "";
        };
        
        //Set the user details in the Cookie. The passed moduleCode is added or removed from the cookie.
        var setUserDetails = function(moduleCode){
            console.log("Heyooo");
            var oldUserDetails = getUserDetails();
            
            //New User
            if(oldUserDetails==""){
                var newCookie = "false,"+moduleCode+","+moduleCode;
                return 1;
            }
            //User removing only checked module
            else if(moduleCode==userDetails[1] && userDetails.length==3){
                document.cookie = "";
                return 1;
            }
            else{
                var newCookie = "false";
                var modules = "";
                var alreadyPresent = false;
                for(var i=MODULES;i<oldUserDetails.length;i++){
                    if(oldUserDetails[i]==moduleCode){
                        alreadyPresent = true;
                    }
                    else{
                        modules += ","+oldUserDetails[i];
                    }
                }
                if(alreadyPresent==false){
                    modules += ","+moduleCode;
                    newCookie+=","+moduleCode+modules;
                }
                else{
                    newCookie=","+oldUserDetails[oldUserDetails.length-1]+modules;
                }
                document.cookie = newCookie;
                return newCookie;
            }
        };
    </script>
</body>
