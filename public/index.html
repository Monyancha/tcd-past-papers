<!DOCTYPE html>
<head>

    <meta charset="utf-8">
    <title>Examinating</title>

    <script src="https://www.gstatic.com/firebasejs/3.6.2/firebase.js"></script>
    
    <link rel="stylesheet" href="examinating.css">
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

</head>
<body>
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container-fluid">
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav navbar-left">
            <li><a href="index.html" id="MyModules">My Modules</a></li>
            <li><a href="modules.html" id="All Modules">All Modules</a></li>
            <li><a href="about.html" id="About">About</a></li>
          </ul>
          <div>
          <form class="navbar-form navbar-right">
            <input type="text" class="form-control" id="textInput" placeholder="Changed..." autocomplete="off" oninput="displaySearchSuggestions();">
        <ul id="suggestionsList" class="list-group">
        </ul>
          </form>
          </div>
        </div>
      </div>
    </nav>
    <div>
    <button type="button" onclick="displaySearchSuggestions()">Click Me!</button>
    </div>
    <div class="col-lg-6" id="modulesBox">
    </div>
    <div class="col-lg-6 text-center" id="yearsBox">
    </div>
    <script>

        // Set the configuration for your app
        // TODO: Replace with your project's config object
        // Initialize Firebase
        var config = {
            apiKey: "AIzaSyB7DdCYWWF1hghR6G8tdLCTMT12L86rLds",
            authDomain: "tcdpastpapers.firebaseapp.com",
            databaseURL: "https://tcdpastpapers.firebaseio.com",
            storageBucket: "tcdpastpapers.appspot.com",
            messagingSenderId: "856128016051"
        };
        firebase.initializeApp(config);

        // Get a reference to the database service
        var db = firebase.database();

        var MODULE_ID = 0;
        var YEAR_OF_COURSE = 1;
        var MODULE_NAME = 2;
        var LINK = 3;
        var ACADEMIC_YEAR = 4;
        
        var LAST_ACTIVE_MODULE = 1;
        var MODULES = 2;
        var YEARS = 2016-1998;

        var SEARCH_SUGGESTION_LIMIT = 5;
        
        window.addEventListener('load',function(){ startUp();},false);
        
        //Deal with how e.g. Elementary Greek is CL0021 and CL1005 (fix them in the CSV maybe?)
        //Deal with how e.g. Postgraduate Business degree 1st year is in with undergraduate jf because both start with BU.
        //      i.e. also Some ICT students have modules starting with CS
        //Deal with how module years are displayed where two papers are present in one year for a single module
        //Deal with the fact that some modules have changed year of study
        //Deal with how Fadas and the french equivalent etc are displayed as diamonds
        //Display a module's name by its newest name: *not its oldest*
              
        //Code run once the page is loaded.
        var startUp = function(){
            var lastActiveModule1 = getCookie("lastActiveModule1");
            displayYears(lastActiveModule1);
            displayModulesBox();
        }
        
        //Display the appropriate content for the user in the modulesBox.
        var displayModulesBox = function(){
            var modulesString = getCookie("modules1");
            if(modulesString==""){
                var modulesBox = document.getElementById("modulesBox");
                modulesBox.innerHTML =
                    `<p>
                        Welcome to Trinity Exam Papers. This website is for students to find past papers in a less convoluted way.

                        This site uses cookies to remember what modules you do so that it can show you those past papers when you visit.

                        To have your modules' past papers show up on the home page, tick which modules you study on the "All Courses" page.
                    </p>`;
            }
            else{
                var modules = modulesString.split(',');
                var newDiv = document.createElement('div');
                newDiv.id = 'modulesBox';
                newDiv.setAttribute('class',"col-lg-6");
                var modulesList = document.createElement('ul');
                for(var i=0;i<modules.length;i++){
                    addModule(modules[i],modulesList);
                }
            
                newDiv.append(modulesList);
                var modulesBox = document.getElementById("modulesBox");
                modulesBox.parentNode.replaceChild(newDiv,modulesBox);
            }
        };
        
        //Display the years for a module in the yearsBox.
        var displayYears = function(moduleCode){

            if(moduleCode==""){ return -1; }

            db.ref().child('Modules').child(moduleCode).once('value').then(function(snapshot){ 

                var module = snapshot.val(); 
                var moduleName  = module["name"];
                var papers = module["papers"];

                document.cookie = "lastActiveModule1="+moduleCode+";";
                if(moduleCode==""){ return -1; }
                var htmlListOfYears = "<h2>"+moduleName+"</h2><ul>";
                for(var i=0;i<papers.length;i++){
                    htmlListOfYears += "<li><a href=\""+papers[i]["link"]+"\">"+papers[i]["year"]+"</a></li>";
                }
                var htmlListOfModuleNames = "</ul>"
                var yearsBox = document.getElementById("yearsBox");
                yearsBox.innerHTML = htmlListOfYears;

                //Set the height of the box
                var bodyHeight = document.getElementsByTagName('html')[0].clientHeight;
                var modulesBox = document.getElementById('modulesBox');
                var yearsBox = document.getElementById('yearsBox');
                var navHeight = document.getElementsByTagName('nav')[0].clientHeight;
                if(modulesBox.clientHeight<bodyHeight){
                    modulesBox.style["margin-top"] = ((bodyHeight/2)-(modulesBox.clientHeight/2))+(navHeight)+"px";
                }
                if(yearsBox.clientHeight<bodyHeight){
                    yearsBox.style["margin-top"] = ((bodyHeight/2)-(yearsBox.clientHeight/2))+(navHeight)+"px";
                }

            });

        };

    
        //Set the user details in the Cookie. The passed moduleCode is added or removed from the cookie.
        var setUserDetails = function(moduleCode){
            console.log("Setting the user details. What was clicked was: "+moduleCode);
            var modulesString = getCookie("modules1");
            var modules = modulesString.split(',');
            //New User
            if(modulesString==""){
                document.cookie = "lastActiveModule1="+moduleCode+"; "
                document.cookie = "modules1="+moduleCode+"; ";
                console.log("1 The new cookie is: "+document.cookie+".");
            }
            //User removing only checked module
            else if(moduleCode==modules[0] && modules.length==1){
                document.cookie = "lastActiveModule1=; path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC";
                document.cookie = "modules1=; path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC";
                console.log("2 The new cookie is: "+document.cookie+".");
            }
            else{
                var modulesList = "";
                var alreadyPresent = false;
                for(var i=0;i<modules.length;i++){
                    console.log("Checking that "+modules[i]+" is not "+moduleCode+".");
                    if(modules[i]==moduleCode){
                        console.log("It was.");
                        alreadyPresent = true;
                    }
                    else{
                        console.log("Adding "+modules[i]+" to the modulesList.");
                        modulesList += modules[i]+",";
                    }
                }
                if(alreadyPresent==false){
                    modulesList += moduleCode;
                    document.cookie = "lastActiveModule1="+moduleCode+";  path=/; "
                    document.cookie = "modules1="+modulesList+";  path=/; ";
                    console.log("3 The new cookie is: "+document.cookie+".");
                }
                else{
                    modulesList = modulesList.substring(0, modulesList.length - 1);
                    var last = getCookie("lastActiveModule1");
                    if(last==moduleCode){
                        document.cookie = "lastActiveModule1="+modules[0]+";  path=/; "
                        document.cookie = "modules1="+modulesList+";  path=/; ";
                        console.log("4 The new cookie is: "+document.cookie+".");
                    }
                    else{
                        document.cookie = "lastActiveModule1="+last+";  path=/; "
                        document.cookie = "modules1="+modulesList+";  path=/; ";
                        console.log("5 The new cookie is: "+document.cookie+".");
                    }
                }
            }
            return 1;
        };

        function addModule(id, parentNode){

            var li = document.createElement('li');

            li.id = id;
            li.className = "text-left";
            li.onclick = function(){ displayYears(id); };

            li.append(document.createTextNode(id))

            getModuleName(id).then(function(name){
                li.innerHTML += ' ' + name;
                parentNode.appendChild(li);
            })
        }

        //Returns promise containing name
        function getModuleName(id){
          return db.ref().child('Modules').child(id).once('value').then(function(snapshot){ return snapshot.val().name; });
        }


        //displays the search Suggestions box
        function displaySearchSuggestions(){

            var searchVal = document.getElementById('textInput').value;

            db.ref().child('Modules').orderByKey().startAt(searchVal).limitToFirst(SEARCH_SUGGESTION_LIMIT).once('value').then(function(snapshot){ 

                var keys = Object.keys(snapshot.val());
                var newSuggestionsList = document.createElement('ul');
                newSuggestionsList.id = 'suggestionsList';
                if(searchVal!=""){
                    for(var i=0;i<keys.length;i++){

                        var sug = document.createElement('li');
                        var input = document.createElement('input');

                        input.type = "checkbox";
                        input.setAttribute('onclick',"setUserDetails('"+keys[i]+"'); startUp();");

                        sug.append(input);
                        sug.append(document.createTextNode(keys[i]));
                        sug.setAttribute('class','list-group-item');

                        newSuggestionsList.append(sug);
                    }
                }
                var suggestionsList = document.getElementById('suggestionsList');
                suggestionsList.parentNode.replaceChild(newSuggestionsList,suggestionsList);
            });
        }
        
        //Returns the value of a Cookie
        var getCookie = function(cname) {
            var name = cname + "=";
            var ca = document.cookie.split(';');
            for(var i = 0; i <ca.length; i++) {
                var c = ca[i];
                while (c.charAt(0)==' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(name) == 0) {
                    return c.substring(name.length,c.length);
                }
            }
            return "";
        };

    </script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
</body>
