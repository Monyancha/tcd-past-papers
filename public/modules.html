<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <title>Examinating - Courses</title>

    <script src="https://www.gstatic.com/firebasejs/3.6.2/firebase.js"></script>
    
    <link rel="stylesheet" href="examinating.css">
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
</head>
<body>
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container-fluid">
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav navbar-left">
            <li><a href="index.html" id="MyModules">My Modules</a></li>
            <li><a href="modules.html" id="All Modules">All Modules</a></li>
            <li><a href="about.html" id="About">About</a></li>
          </ul>
          <form class="navbar-form navbar-right">
            <input type="text" class="form-control" placeholder="Search...">
          </form>
        </div>
      </div>
    </nav>
    <div id="options">
        Waiting for Files to be read.
    </div>
    <script>

/*----DATABASE INITIALISATION---------------------------------------------------------------------------------------------------*/

        var config = {
            apiKey: "AIzaSyB7DdCYWWF1hghR6G8tdLCTMT12L86rLds",
            authDomain: "tcdpastpapers.firebaseapp.com",
            databaseURL: "https://tcdpastpapers.firebaseio.com",
            storageBucket: "tcdpastpapers.appspot.com",
            messagingSenderId: "856128016051"
        };
        firebase.initializeApp(config);
        var db = firebase.database();

/*----UNIVERSAL CONSTANTS-------------------------------------------------------------------------------------------------------*/

        var MODULE_ID = 0;
        var YEAR = 1;
        var MODULE_NAME = 2;
        var LINK = 3;
        var ACADEMIC_YEAR = 4;
        var SEARCH_VALUE = 5;
        var LAST_ACTIVE_MODULE = 1;
        var MODULES = 2;
        var YEARS = 2016-1998;
        
/*----START UP CODE-------------------------------------------------------------------------------------------------------------*/

        window.addEventListener('load',function(){ startUp();},false);
        
        //Code run once the page is loaded.
        var startUp = function(){
            displayCourses();
        }


			    function updateContent(state) {
			    	if (state == null){
			   			return displayCourses();
			    	}
			    	else if(state['year']==null){
			    		return displayYears(state['course']);
			    	}
			    	else{
			    		return displayModules(state['year']+state['course']);
			    	}
			    }

			    // Revert to a previously saved state
			    window.onpopstate = function(event) {
			      console.log('popstate fired!');
			      updateContent(event.state);
			    };

			    /*
			    // Change to a new state
			    window.onpushstate = function(event) {
			      console.log('pushstate fired!');
			      updateContent(event.state);
			    };
			    */
        
/*----DISPLAYING COURSES--------------------------------------------------------------------------------------------------------*/

        var displayCourses = function(){
            var options = document.getElementById("options");
            options.innerHTML = `
                <ul class="courses">
                    <li id="482">Ancient and Medieval History and Culture</li>
                    <li id="23">Biblical and Theological Studies</li>
                    <li id="481">Business and Computing</li>
                    <li id="80">Business Studies</li>
                    <li id="405">Busiess Studies and a Language</li>
                    <li id="456">Chemistry with Molecular Modelling</li>
                    <li id="457">Children's and General Nursing (BSc)</li>
                    <li id="5">Classics&nbsp;</li>
                    <li id="37">Clinical Speech and Language Studies</li>
                    <li id="19">Computer Science (B.A.)&nbsp;</li>
                    <li id="412">Computer Science (B.Sc.)</li>
                    <li id="299">Computer Science (Integrated)</li>
                    <li id="57">Computer Science, Linguistics and a Language</li>
                    <li id="503">Deaf Studies (Bachelor)</li>
                    <li id="447">Deaf Studies (Diploma)</li>
                    <li id="406">Dental Hygiene (Diploma)</li>
                    <li id="461">Dental Nursing (Diploma)</li>
                    <li id="67">Dental Science</li>
                    <li id="459">Dental Technology (Bachelor)</li>
                    <li id="27">Drama and Theatre Studies</li>
                    <li id="31">Early and Modern Irish</li>
                    <li id="477">Earth Sciences</li>
                    <li id="46">Economic and Social Studies&nbsp;</li>
                    <li id="98">Education (B.Ed.)</li>
                    <li id="48">English Studies</li>
                    <li id="70">Engineering</li>
                    <li id="280">Engineering (Integrated)</li>
                    <li id="450">Engineering Double Diplome</li>
                    <li id="464">Engineering with Management</li>
                    <li id="287">Engineering with Management (Integrated)</li>
                    <li id="53">European Studies</li>
                    <li id="445">European Studies Double Diploma</li>
                    <li id="432">Foundation Course for Higher Education - Mature Students</li>
                    <li id="437">Foundation Course for Higher Education - Young Adults</li>
                    <li id="49">Germanic Languages</li>
                    <li id="40">History</li>
                    <li id="97">History of European Painting (Diploma)</li>
                    <li id="26">History and Political Science</li>
                    <li id="420">Human Genetics</li>
                    <li id="476">Human Health and Disease</li>
                    <li id="453">Information Systems (Diploma) </li>
                    <li id="454">Information Systems (BSc Hons) </li>
                    <li id="463">Irish Studies</li>
                    <li id="51">Law</li>
                    <li id="408">Law and French</li>
                    <li id="409">Law and German</li>
                    <li id="478">Law and Business</li>
                    <li id="479">Law and Political Science</li>
                    <li id="18">Management Science and Information Systems Studies (MSISS)</li>
                    <li id="439">Manufacturing Engineering with Management Science (MEMS)</li>
                    <li id="89">Mathematics</li>
                    <li id="66">Medicine</li>
                    <li id="455">Medicine (5-year)</li>
                    <li id="436">Medicinal Chemistry</li>
                    <li id="6">Mental and Moral Science</li>
                    <li id="458">Midwifery (BSc)</li>
                    <li id="448">Midwifery Studies (Bachelor)</li>
                    <li id="41">Music</li>
                    <li id="55">Music Education (B.Ed.)</li>
                    <li id="15">Natural Sciences</li>
                    <li id="446">Nursing Studies (BSc)</li>
                    <li id="444">Nursing Studies (October intake)</li>
                    <li id="54">Occupational Therapy</li>
                    <li id="59">Pharmaceutical Technicians (Diploma)</li>
                    <li id="16">Pharmacy</li>
                    <li id="472">Philosophy</li>
                    <li id="414">Philosophy and Political Science</li>
                    <li id="470">Philosophy, Political Science, Economics and Sociology</li>
                    <li id="440">Physics and Chemistry of Advanced Materials</li>
                    <li id="17">Physiotherapy</li>
                    <li id="480">Political Science and Geography</li>
                    <li id="12">Psychology</li>
                    <li id="451">Radiation Therapy</li>
                    <li id="462">Religions and Theology</li>
                    <li id="85">Social Studies&nbsp;</li>
                    <li id="413">Sociology and Social Policy</li>
                    <li id="52">Theology</li>
                    <li id="404">Theoretical Physics</li>
                    <li id="84">World Religions and Theology (New Course 2010/11)</li>
                    <li id="706">Applied Building Repair and Conservation (PG Diploma)</li>
                    <li id="743">Applied Psychology (M.Sc)</li>
                    <li id="110">Business Administration (Masters)</li>
                    <li id="794">Business Administration (PT) (Masters)</li>
                    <li id="694">Business and Management (M.Sc)</li>
                    <li id="802">Cancer Care (M.Sc)</li>
                    <li id="676">Cardiac Rehabilitation (M.Sc)</li>
                    <li id="224">Child and Adolescent Analytic Psychotherapy (M.Sc)</li>
                    <li id="755">Children's Nursing(RCN) (Higher Diploma)</li>
                    <li id="211">Civil Engineering (old course) (M.Sc)</li>
                    <li id="525">Civil Engineering (new course) (M.Sc)</li>
                    <li id="778">Classics (Master in Philosophy)</li>
                    <li id="629">Clinical Practice (PG Diploma)</li>
                    <li id="609">Cognitive Psychotherapy (M.Sc)</li>
                    <li id="612">Cognitive Psychotherapy (PG Diploma)</li>
                    <li id="569">Comparative European Politics (PT) (M.Sc)</li>
                    <li id="619">Computer Science (Networks and Distributed Systems)(M.Sc)</li>
                    <li id="739">Computer Science (Mobile and Ubiquitous Computing)(M.Sc)</li>
                    <li id="769">Computer Science (Interactive Entertainment Technology)(M.Sc)</li>
                    <li id="702">Computer Science (Ubiqutous Computing) (Master)</li>
                    <li id="130">Computers for Engineers (PG Diploma)</li>
                    <li id="805">Computing with Advanced Interdisciplinary Outlook (PG Diploma)</li>
                    <li id="807">Computing (Conversion) with Advanced Interdisciplinary Outlook (PG Diploma)</li>
                    <li id="614">Construction Law and Contract Administration (PG Diploma)</li>
                    <li id="622">Dental Surgery (Master)</li>
                    <li id="628">Early Irish (Master in Philosophy)</li>
                    <li id="645">Economic Policy (M.Sc)</li>
                    <li id="601">Education (Primary Teaching - Higher Diploma)</li>
                    <li id="762">Education (PG Diploma)</li>
                    <li id="201">Environmental Engineering (PG Diploma)</li>
                    <li id="799">Exercise Physiology (MSc)</li>
                    <li id="566">Finance (FT) (MSc)</li>
                    <li id="567">Finance (PT) (MSc)</li>
                    <li id="637">Fire Safety Practice (PG Diploma)</li>
                    <li id="248">German Language Literature and Language (Master in Philosophy)</li>
                    <li id="705">Health and Safety in Construction (PG Diploma)</li>
                    <li id="616">Health Informatics (PG Piploma)</li>
                    <li id="626">High Performance Computing (M.Sc)</li>
                    <li id="186">Highway and Geotechnical Engineering (PG Diploma)</li>
                    <li id="781">Interactive Digital Media (M.Sc)</li>
                    <li id="792">International Management (Masters)</li>
                    <li id="607">LLM (Master in Laws)</li>
                    <li id="700">Management Information Systems (M.Sc)</li>
                    <li id="733">Mechanical Engineering (Erasmus Mundus - M.Sc)</li>
                    <li id="438">Midwifery (PG Diploma)</li>
                    <li id="605">Midwifery (M.Sc)</li>
                    <li id="767">Midwifery (Higher Diploma)</li>
                    <li id="263">Multimedia Systems (M.Sc)</li>
                    <li id="604">Nursing (M.Sc)</li>
                    <li id="421">Nursing Studies (PG Diploma)</li>
                    <li id="627">Old Irish (PG Diploma)</li>
                    <li id="264">Paediatrics (M.Sc)</li>
                    <li id="633">Pharmaceutical Analysis (M.Sc) (98/99-06/07)</li>
                    <li id="544">Pharmaceutical Analysis (M.Sc) (07/08-10/11)</li>
                    <li id="210">Physical Planning for Engineers (PG Diploma)</li>
                    <li id="136">Project Management (PG Diploma)</li>
                    <li id="720">Psychology (Higher Diploma) </li>
                    <li id="272">Quality Improvement (PG Diploma)</li>
                    <li id="669">Social Work (Masters)</li>
                    <li id="649">Specialist Nursing (PG Diploma)</li>
                    <li id="689">Specialist Nursing (M.Sc)</li>
                    <li id="08">Sports Medicine (M.Sc )</li>
                    <li id="129">Statistics (PG Diploma)</li>
                </ul>`;

            //Add an onclick attribute to all listelements in lists of class 'courses' to displayYears()
            var links = document.getElementsByTagName('li');
            var howLongEachCourseHasBeenAround = "";
            for(var i=0;i<links.length;i++) {
                var link = links[i];
                if(link.parentElement.getAttribute('class') == 'courses') {
                    link.setAttribute("onclick","courseClicked("+link.getAttribute('id')+");");
                }
            }
        }


/*----DISPLAYING YEARS-----------------------------------------------------------------------------------------------------------*/

		var courseClicked = function(searchValue){
			console.log("YOHO");
        	//Update the url to contain the course search value
			var state = { course: searchValue };
			history.pushState(state, searchValue, "modules.html?course="+searchValue);
			updateContent(state);
		}

        //Displays the years of the course with the given searchValue
        var displayYears = function(searchValue){

        	//Get all years of the course from the database
            db.ref().child('Courses').child(searchValue).once('value').then(function(snapshot){ 

                var course = snapshot.val(); 

                //Create a ul element with each of the years of the course
                var listOfYears = "<a href=\"modules.html\"><-- All Courses</a><ul class=\"years\">";
                for(var i=0;i<course.length;i++){
                    if(i==0){
                        listOfYears += "<li id=\""+(i+1)+searchValue+"\">1st year</li>";
                    }
                    else if(i==1){
                        listOfYears += "<li id=\""+(i+1)+searchValue+"\">2nd year</li>";
                    }
                    else if(i==2){
                        listOfYears += "<li id=\""+(i+1)+searchValue+"\">3rd year</li>";
                    }
                    else{
                        listOfYears += "<li id=\""+(i+1)+searchValue+"\">"+(i+1)+"th year</li>";
                    }
                }
                listOfYears += "</ul><div id=\"modulesOfTheYear\"></div>"

                var options = document.getElementById("options");
                options.innerHTML = listOfYears;

                //Add on onclick method to each of the listelements in lists of class 'years' to displayModules
                var links = document.getElementsByTagName('li');
                for(var i=0;i<links.length;i++) {
                    var link = links[i];
                    var linkIDString = ""+link.getAttribute('id');
                    if(link.parentElement.getAttribute('class') == 'years') {
                        link.setAttribute("onclick","yearClicked("+linkIDString+");");
                    }
                }
            });
        }
       
/*----START UP CODE-------------------------------------------------------------------------------------------------------------*/

		//Changes the history state when a year of a course has been clicked
		var yearClicked = function(linkID){
            var listString = ""+linkID;
            var yearOfCourse = listString.substring(0,1);  
            var searchValue = listString.substring(1,listString.length);
        	//Update the url to contain the year of the course
			var state = { course: searchValue, year: yearOfCourse };
			history.pushState(state, searchValue+' year '+yearOfCourse, "modules.html?course="+searchValue+"&year="+yearOfCourse);
			updateContent(state);
		}

        //Takes a String with a yearOfCourse+SearchValue and adds a list to the "modulesOfTheYear" element
        var displayModules = function(listElement){

            var newModulesDiv = document.createElement('div');
            newModulesDiv.id = 'modulesOfTheYear';
            var listOfModules =  document.createElement('ul');
            var listElementString = ""+listElement;
            var savedModulesString = getCookie("modules1");
            var savedModules = savedModulesString.split(',');
            var yearOfCourse = listElementString.substring(0,1);  
            var searchValue = listElementString.substring(1,listElementString.length);

            //Get all modules for the course
            db.ref().child('Courses').child(searchValue).once('value').then(function(snapshot){ 

                var course;
                course = snapshot.val(); 
                var year = course[yearOfCourse-1];

                //Add all modules in the year to the list of modules
                for(var i=0;i<year.length;i++){
                    var alreadySaved = false;
                    for(var j=0;j<savedModules.length;j++){;
                        if(savedModules[j]==year[i]){
                            alreadySaved = true; break;
                        }
                    }
                    addModule(year[i],listOfModules,alreadySaved);
                }

                //Replace old list of modules with the new one
                newModulesDiv.append(listOfModules);
                var modulesOfTheYear = document.getElementById("modulesOfTheYear");
                modulesOfTheYear.parentNode.replaceChild(newModulesDiv,modulesOfTheYear);

            });
        }

        //Adds a module with module code 'id' to a list 'parentNode', with a checkbox (defaults to unchecked).
         function addModule(id, parentNode,checked){
            var li = document.createElement('li');
            var input = document.createElement('input');
            input.type = "checkbox";
            input.setAttribute('onclick',"setUserDetails('"+id+"');");
            if(checked){
                input.setAttribute('checked', '');
            }
            li.id = id;
            li.append(input);
            li.append(document.createTextNode(id));
            getModuleName(id).then(function(name){
                li.innerHTML += ' ' + name;
                parentNode.appendChild(li);
            })
        }

/*----DATABASE-------------------------------------------------------------------------------------------------------------*/

        //Returns promise containing name
        function getModuleName(id){
          return db.ref().child('Modules').child(id).once('value').then(function(snapshot){ return snapshot.val().name; });
        }

/*----COOKIES--------------------------------------------------------------------------------------------------------------*/

        //Set the user details in the Cookie. The passed moduleCode is added or removed from the cookie.
        var setUserDetails = function(moduleCode){
            console.log("Setting now. What was clicked was: "+moduleCode);
            var modulesString = getCookie("modules1");
            var modules = modulesString.split(',');
            //New User
            if(modulesString==""){
                document.cookie = "lastActiveModule1="+moduleCode+";  path=/; "
                document.cookie = "modules1="+moduleCode+";  path=/; ";
                console.log("1 The new cookie is: "+document.cookie+".");
            }
            //User removing only checked module
            else if(moduleCode==modules[0] && modules.length==1){
                document.cookie = "lastActiveModule1=;  path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC";
                document.cookie = "modules1=;  path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC";
                console.log("2 The new cookie is: "+document.cookie+".");
            }
            else{
                var modulesList = "";
                var alreadyPresent = false;
                for(var i=0;i<modules.length;i++){
                    console.log("Checking that "+modules[i]+" is not "+moduleCode+".");
                    if(modules[i]==moduleCode){
                        console.log("It was.");
                        alreadyPresent = true;
                    }
                    else{
                        console.log("Adding "+modules[i]+" to the modulesList.");
                        modulesList += modules[i]+",";
                    }
                }
                if(alreadyPresent==false){
                    modulesList += moduleCode;
                    document.cookie = "lastActiveModule1="+moduleCode+";  path=/; "
                    document.cookie = "modules1="+modulesList+";  path=/; ";
                    console.log("3 The new cookie is: "+document.cookie+".");
                }
                else{
                    modulesList = modulesList.substring(0, modulesList.length - 1);
                    var last = getCookie("lastActiveModule1");
                    if(last==moduleCode){
                        document.cookie = "lastActiveModule1="+modules[0]+";  path=/; "
                        document.cookie = "modules1="+modulesList+";  path=/; ";
                        console.log("4 The new cookie is: "+document.cookie+".");
                    }
                    else{
                        document.cookie = "lastActiveModule1="+last+";  path=/; "
                        document.cookie = "modules1="+modulesList+";  path=/; ";
                        console.log("5 The new cookie is: "+document.cookie+".");
                    }
                }
            }
            return 1;
        };
        
        //Returns the value of a Cookie
        var getCookie = function(cname) {
            var name = cname + "=";
            var ca = document.cookie.split(';');
            for(var i = 0; i <ca.length; i++) {
                var c = ca[i];
                while (c.charAt(0)==' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(name) == 0) {
                    return c.substring(name.length,c.length);
                }
            }
            return "";
        };

        var clearCookies = function(){document.cookie = "expires=Thu, 01 Jan 1970 00:00:00 UTC";}        
    </script>
</body>
